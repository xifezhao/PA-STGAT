
# Privacy-Enhanced Spatiotemporal Graph Attention Network (PA-STGAT)

[![Python 3.8+](https://img.shields.io/badge/python-3.8+-blue.svg)](https://www.python.org/downloads/)
[![PyTorch](https://img.shields.io/badge/PyTorch-%23EE4C2C.svg?&style=flat&logo=pytorch&logoColor=white)](https://pytorch.org/)
[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)

This repository contains the official PyTorch implementation for **PA-STGAT**, a novel framework for high-accuracy, privacy-preserving traffic forecasting. The project demonstrates how to build and evaluate a state-of-the-art spatiotemporal graph neural network within a robust Federated Learning (FL) and Differential Privacy (DP) protocol.

The primary script (`main.py` or your chosen filename) is a self-contained, academic-grade implementation that performs a comprehensive, end-to-end experimental evaluation, including:
1.  **Our Model (PA-STGAT)**: Training an advanced spatiotemporal graph attention network in a decentralized, privacy-preserving setting (DP-FedAvg).
2.  **Privacy-Utility Trade-off Analysis**: Systematically evaluating the model's performance under varying levels of privacy guarantees.
3.  **SOTA Benchmarking**: Implementing and comparing against a full suite of baseline models, from classical methods (HA, VAR) to modern deep learning architectures (LSTM, GAT, STGCN).
4.  **Qualitative Analysis**: Generating visualizations to compare model predictions against ground truth during critical traffic events (e.g., peak-hour congestion).
5.  **Reproducibility**: Automatically generating all tables and figures presented in a research paper from a single script run.

![Qualitative Analysis Plot](qualitative_analysis_peak_hour.pdf)
*An example of the qualitative analysis plot generated by the script, comparing PA-STGAT's predictions against ground truth and a baseline during a peak-hour congestion event.*

## Table of Contents
- [Privacy-Enhanced Spatiotemporal Graph Attention Network (PA-STGAT)](#privacy-enhanced-spatiotemporal-graph-attention-network-pa-stgat)
  - [Table of Contents](#table-of-contents)
  - [Features](#features)
  - [Methodology Overview](#methodology-overview)
  - [Setup and Installation](#setup-and-installation)
    - [Prerequisites](#prerequisites)
    - [Dataset](#dataset)
  - [Running the Experiment](#running-the-experiment)
  - [Output Files](#output-files)
  - [Model Architectures](#model-architectures)
  - [License](#license)

## Features
- **Holistic Framework**: Combines a GAT for spatial modeling and a GRU for temporal dependency learning.
- **Privacy-by-Design**: Built on a Federated Learning (FL) framework with Differential Privacy (DP) to ensure data remains decentralized and individual contributions are protected.
- **Full Reproducibility**: A single, self-contained script to replicate all experimental results, including benchmarking tables and analysis plots.
- **Comprehensive Benchmarking**: Includes implementations of Historical Average (HA), Vector Autoregression (VAR), LSTM, GAT, and a STGCN-like model for thorough comparison.
- **Rigorous Evaluation**: Automatically calculates standard metrics (MAE, RMSE, MAPE) and presents results averaged over multiple independent runs with standard deviations.

## Methodology Overview
PA-STGAT addresses two key challenges in traffic forecasting:
1.  **Technical Challenge**: Modeling the complex, non-linear spatiotemporal dependencies in urban traffic networks.
2.  **Privacy Challenge**: Training a powerful model on sensitive data owned by different stakeholders without centralizing it.

Our solution is built on three pillars:
- **Pillar 1: Spatiotemporal Graph Attention**: A GAT captures dynamic spatial relationships at each time step, and a GRU models the temporal evolution of these relationships.
- **Pillar 2: Federated Learning**: A decentralized training paradigm (FedAvg) allows multiple "clients" (representing different data owners) to collaboratively train a global model without sharing their raw data.
- **Pillar 3: Differential Privacy**: Calibrated noise is added to model updates before aggregation, providing formal mathematical guarantees against information leakage.

## Setup and Installation

### Prerequisites
The code is written in Python 3 and requires several libraries. You can install them using `pip`:
```bash
pip install torch numpy pandas matplotlib tqdm scipy scikit-learn h5py torch-geometric statsmodels
```
*Note: Ensure your PyTorch version is compatible with your CUDA installation if you plan to use a GPU.*

### Dataset
This project uses the **METR-LA** dataset, a large-scale traffic dataset from Los Angeles County. You need to download two files:
1.  `metr-la.h5`: The time-series traffic speed data.
2.  `adj_mx.pkl`: The adjacency matrix representing the road network graph.

These files should be placed in a `./Data/` directory relative to the script's location. The script will automatically look for them there.
```
.
├── main.py        # Your Python script
└── Data/
    ├── metr-la.h5
    └── adj_mx.pkl
```

## Running the Experiment

To run the entire experimental pipeline, simply execute the Python script from your terminal:
```bash
python main.py
```
The script will perform the following steps automatically:
1.  Load and preprocess the METR-LA dataset.
2.  Run the main experiment: Train and evaluate PA-STGAT over 3 independent runs for 3 different privacy levels (Weak, Medium, Strong). This part may take a significant amount of time, especially on a CPU.
3.  Save the best-performing model (`best_model_state.pth`) from the weakest privacy setting.
4.  Run the full SOTA benchmarking against all baseline models in a centralized setting.
5.  Generate all result files (CSVs and PDFs) in the root directory.

## Output Files

After a successful run, the following files will be generated in the project's root directory:

-   `overall_performance_comparison.csv`: A table comparing PA-STGAT (centralized and federated) against all SOTA baselines for short-term and long-term forecasting horizons.
-   `privacy_utility_tradeoff.csv`: A table quantifying the model's performance (Test MAE) at different privacy levels (noise multipliers).
-   `ablation_study.csv`: A conceptual table showing the importance of the model's different components.
-   `privacy_utility_intervals.pdf`: A plot showing the validation MAE convergence curves for each privacy level, averaged over multiple runs with standard deviation intervals.
-   `qualitative_analysis_peak_hour.pdf`: A plot visualizing the model's predictions against ground truth for selected sensors during a congestion event.
-   `best_model_state.pth`: The saved state dictionary of the best-performing federated model, used for benchmarking and qualitative analysis.

## Model Architectures
The script implements the following models for a comprehensive comparison:

-   **PA-STGAT**: Our proposed model combining a GAT and a GRU.
-   **Historical Average (HA)**: A simple baseline that predicts the future value as the historical mean.
-   **Vector Autoregression (VAR)**: A classical statistical model for multivariate time series.
-   **LSTM**: A standard recurrent neural network baseline that ignores spatial structure.
-   **GAT**: A baseline using only the Graph Attention Network on the last time step, ignoring temporal dynamics.
-   **STGCN-like**: A simplified implementation of the Spatio-Temporal Graph Convolutional Network, combining GCN and GRU layers.
-   **DCRNN**: Results for this model are cited directly from the original paper, as it is a well-established benchmark.



## License
This project is licensed under the MIT License. See the `LICENSE` file for details.
